/*drop table if exists tmp_lapsed;
create table if not EXISTS tmp_lapsed (ik text, yksus text, kood text, alg_kpv text, lopp_kpv text);

insert into  tmp_lapsed (ik , yksus , kood , alg_kpv , lopp_kpv )
SELECT
    t.f[1]::text AS ik
        ,t.f[2]::text AS yksus
        ,t.f[3]::text AS kood
        ,t.f[4]::text AS alg_kpv
        ,t.f[5]::text AS lopp_kpv

FROM (
         SELECT regexp_split_to_array(l, ';') AS f
         FROM regexp_split_to_table(
                      $$51711200027;LAED-001-04;322020-014;31.12.2020;31.12.2010
51711200027;LAED-001-04;322030-016;31.12.2020;31.12.2010
51712200043;LAED-001-04;322020-014;31.12.2020;31.12.2010
51712200043;LAED-001-04;322030-016;31.12.2020;31.12.2010
51712200043;LAED-001-04;322040-003;31.12.2020;31.12.2010
51712200043;LAED-001-04;322040-004;31.12.2020;31.12.2010
51712200043;LAED-001-04;322040-005;31.12.2020;31.12.2010
51802260127;LAED-001-04;322020-014;31.12.2020;31.12.2010
51802260127;LAED-001-04;322030-016;31.12.2020;31.12.2010
51802260127;LAED-001-04;322040-003;31.12.2020;31.12.2010
51802260127;LAED-001-04;322040-004;31.12.2020;31.12.2010
51802260127;LAED-001-04;322040-005;31.12.2020;31.12.2010
51803160224;LAED-001-04;322020-014;31.12.2020;31.12.2010
51803160224;LAED-001-04;322030-016;31.12.2020;31.12.2010
51803160224;LAED-001-04;322040-003;31.12.2020;31.12.2010
51803160224;LAED-001-04;322040-004;31.12.2020;31.12.2010
51803160224;LAED-001-04;322040-005;31.12.2020;31.12.2010
51807060097;LAED-001-05;322020-014;31.12.2020;31.12.2010
51807060097;LAED-001-05;322030-016;31.12.2020;31.12.2010
51807060097;LAED-001-05;322040-003;31.12.2020;31.12.2010
51807060097;LAED-001-05;322040-004;31.12.2020;31.12.2010
51807060097;LAED-001-05;322040-005;31.12.2020;31.12.2010
51809090051;LAED-001-04;322020-014;31.12.2020;31.12.2010
51809090051;LAED-001-04;322030-016;31.12.2020;31.12.2010
51809090051;LAED-001-04;322040-003;31.12.2020;31.12.2010
51809090051;LAED-001-04;322040-004;31.12.2020;31.12.2010
51809090051;LAED-001-04;322040-005;31.12.2020;31.12.2010
51812210173;LAED-001-06;322020-014;31.12.2020;31.12.2010
51812210173;LAED-001-06;322030-016;31.12.2020;31.12.2010
51812210173;LAED-001-06;322040-003;31.12.2020;31.12.2010
51812210173;LAED-001-06;322040-004;31.12.2020;31.12.2010
51812210173;LAED-001-06;322040-005;31.12.2020;31.12.2010
51902130114;LAED-001-04;322020-014;31.12.2020;31.12.2010
51902130114;LAED-001-04;322030-016;31.12.2020;31.12.2010
51902130114;LAED-001-04;322040-003;31.12.2020;31.12.2010
51902130114;LAED-001-04;322040-004;31.12.2020;31.12.2010
51902130114;LAED-001-04;322040-005;31.12.2020;31.12.2010
51903040153;LAED-001-06;322020-014;31.12.2020;31.12.2010
51903040153;LAED-001-06;322030-016;31.12.2020;31.12.2010
51903040153;LAED-001-06;322040-003;31.12.2020;31.12.2010
51903040153;LAED-001-06;322040-004;31.12.2020;31.12.2010
51903040153;LAED-001-06;322040-005;31.12.2020;31.12.2010
51903250248;LAED-001-06;322020-014;31.12.2020;31.12.2010
51903250248;LAED-001-06;322030-016;31.12.2020;31.12.2010
51903250248;LAED-001-06;322040-003;31.12.2020;31.12.2010
51903250248;LAED-001-06;322040-004;31.12.2020;31.12.2010
51903250248;LAED-001-06;322040-005;31.12.2020;31.12.2010
51907010217;LAED-001-05;322020-014;4.01.2021;31.12.2010
51907010217;LAED-001-05;322030-016;4.01.2021;31.12.2010
51907010217;LAED-001-05;322040-003;4.01.2021;31.12.2010
51907010217;LAED-001-05;322040-004;4.01.2021;31.12.2010
51907010217;LAED-001-05;322040-005;4.01.2021;31.12.2010
61801070053;LAED-001-04;322020-014;31.12.2020;31.12.2010
61801070053;LAED-001-04;322030-016;31.12.2020;31.12.2010
61801070053;LAED-001-04;322040-003;31.12.2020;31.12.2010
61801070053;LAED-001-04;322040-004;31.12.2020;31.12.2010
61801070053;LAED-001-04;322040-005;31.12.2020;31.12.2010
61801160096;LAED-001-04;322020-014;31.12.2020;31.12.2010
61801160096;LAED-001-04;322030-016;31.12.2020;31.12.2010
61801160096;LAED-001-04;322040-003;31.12.2020;31.12.2010
61801160096;LAED-001-04;322040-004;31.12.2020;31.12.2010
61801160096;LAED-001-04;322040-005;31.12.2020;31.12.2010
61803220214;LAED-001-04;322020-014;31.12.2020;31.12.2010
61803220214;LAED-001-04;322030-016;31.12.2020;31.12.2010
61803220214;LAED-001-04;322040-003;31.12.2020;31.12.2010
61803220214;LAED-001-04;322040-004;31.12.2020;31.12.2010
61803220214;LAED-001-04;322040-005;31.12.2020;31.12.2010
61805080190;LAED-001-04;322020-014;31.12.2020;31.12.2010
61805080190;LAED-001-04;322030-016;31.12.2020;31.12.2010
61805080190;LAED-001-04;322040-003;31.12.2020;31.12.2010
61805080190;LAED-001-04;322040-004;31.12.2020;31.12.2010
61805080190;LAED-001-04;322040-005;31.12.2020;31.12.2010
61806020217;LAED-001-05;322020-014;31.12.2020;31.12.2010
61806020217;LAED-001-05;322030-016;31.12.2020;31.12.2010
61806020217;LAED-001-05;322040-003;31.12.2020;31.12.2010
61806020217;LAED-001-05;322040-004;31.12.2020;31.12.2010
61806020217;LAED-001-05;322040-005;31.12.2020;31.12.2010
61806130252;LAED-001-04;322020-014;31.12.2020;31.12.2010
61806130252;LAED-001-04;322030-016;31.12.2020;31.12.2010
61806130252;LAED-001-04;322040-003;31.12.2020;31.12.2010
61806130252;LAED-001-04;322040-004;31.12.2020;31.12.2010
61806130252;LAED-001-04;322040-005;31.12.2020;31.12.2010
61807120206;LAED-001-05;322020-014;31.12.2020;31.12.2010
61807120206;LAED-001-05;322030-016;31.12.2020;31.12.2010
61807120206;LAED-001-05;322040-003;31.12.2020;31.12.2010
61807120206;LAED-001-05;322040-004;31.12.2020;31.12.2010
61807120206;LAED-001-05;322040-005;31.12.2020;31.12.2010
61809190167;LAED-001-05;322020-014;31.12.2020;31.12.2010
61809190167;LAED-001-05;322030-016;31.12.2020;31.12.2010
61809190167;LAED-001-05;322040-003;31.12.2020;31.12.2010
61809190167;LAED-001-05;322040-004;31.12.2020;31.12.2010
61809190167;LAED-001-05;322040-005;31.12.2020;31.12.2010
61810300163;LAED-001-04;322020-014;31.12.2020;31.12.2010
61810300163;LAED-001-04;322030-016;31.12.2020;31.12.2010
61810300163;LAED-001-04;322040-003;31.12.2020;31.12.2010
61810300163;LAED-001-04;322040-004;31.12.2020;31.12.2010
61810300163;LAED-001-04;322040-005;31.12.2020;31.12.2010
61811120115;LAED-001-05;322020-014;31.12.2020;31.12.2010
61811120115;LAED-001-05;322030-016;31.12.2020;31.12.2010
61811120115;LAED-001-05;322040-003;31.12.2020;31.12.2010
61811120115;LAED-001-05;322040-004;31.12.2020;31.12.2010
61811120115;LAED-001-05;322040-005;31.12.2020;31.12.2010
61812030101;LAED-001-05;322020-014;31.12.2020;31.12.2010
61812030101;LAED-001-05;322030-016;31.12.2020;31.12.2010
61812030101;LAED-001-05;322040-003;31.12.2020;31.12.2010
61812030101;LAED-001-05;322040-004;31.12.2020;31.12.2010
61812030101;LAED-001-05;322040-005;31.12.2020;31.12.2010
61901260083;LAED-001-06;322020-014;31.12.2020;31.12.2010
61901260083;LAED-001-06;322030-016;31.12.2020;31.12.2010
61901260083;LAED-001-06;322040-003;31.12.2020;31.12.2010
61901260083;LAED-001-06;322040-004;31.12.2020;31.12.2010
61901260083;LAED-001-06;322040-005;31.12.2020;31.12.2010
61902050047;LAED-001-06;322020-014;31.12.2020;31.12.2010
61902050047;LAED-001-06;322030-016;31.12.2020;31.12.2010
61902050047;LAED-001-06;322040-003;1.01.2021;31.12.2010
61902050047;LAED-001-06;322040-004;1.01.2021;31.12.2010
61902050047;LAED-001-06;322040-005;1.01.2021;31.12.2010
61902060152;LAED-001-06;322020-014;31.12.2020;31.12.2010
61902060152;LAED-001-06;322030-016;31.12.2020;31.12.2010
61902060152;LAED-001-06;322040-003;15.04.2021;31.12.2010
61902060152;LAED-001-06;322040-004;15.04.2021;31.12.2010
61902060152;LAED-001-06;322040-005;15.04.2021;31.12.2010
61905150144;LAED-001-06;322020-014;31.12.2020;31.12.2010
61905150144;LAED-001-06;322030-016;31.12.2020;31.12.2010
61905150144;LAED-001-06;322040-003;31.12.2020;31.12.2010
61905150144;LAED-001-06;322040-004;31.12.2020;31.12.2010
61905150144;LAED-001-06;322040-005;31.12.2020;31.12.2010
61906030017;LAED-001-06;322020-014;31.12.2020;31.12.2010
61906030017;LAED-001-06;322030-016;31.12.2020;31.12.2010
61906030017;LAED-001-06;322040-003;31.12.2020;31.12.2010
61906030017;LAED-001-06;322040-004;31.12.2020;31.12.2010
61906030017;LAED-001-06;322040-005;31.12.2020;31.12.2010
61907070133;LAED-001-06;322020-014;31.12.2020;31.12.2010
61907070133;LAED-001-06;322030-016;31.12.2020;31.12.2010
61907070133;LAED-001-06;322040-003;31.12.2020;31.12.2010
61907070133;LAED-001-06;322040-004;31.12.2020;31.12.2010
61907070133;LAED-001-06;322040-005;31.12.2020;31.12.2010
61912130129;LAED-001-05;322020-014;21.04.2021;31.12.2010
61912130129;LAED-001-05;322030-016;21.04.2021;31.12.2010
61912130129;LAED-001-05;322040-003;21.04.2021;31.12.2010
61912130129;LAED-001-05;322040-004;21.04.2021;31.12.2010
61912130129;LAED-001-05;322040-005;21.04.2021;31.12.2010
$$, '\n') AS l) t;
*/
DROP FUNCTION IF EXISTS tmp_update_teenused();

CREATE FUNCTION tmp_update_teenused()
    RETURNS INTEGER
    LANGUAGE plpgsql
AS
$$
DECLARE
    v_lapsed RECORD;
    l_count  INTEGER = 0;
    v_kaart  RECORD;
    l_kpv    DATE;
BEGIN
    FOR v_lapsed IN
        SELECT * FROM tmp_lapsed
        LOOP
            RAISE NOTICE '% % % %',v_lapsed.ik, v_lapsed.alg_kpv, v_lapsed.lopp_kpv, v_lapsed.yksus;
            SELECT *
            INTO v_kaart
            FROM lapsed.lapse_kaart lk
                     INNER JOIN libs.nomenklatuur n ON lk.nomid = n.id
            WHERE parentid IN (SELECT id FROM lapsed.laps WHERE isikukood = v_lapsed.ik)
              AND lk.rekvid = 92
              AND n.kood::TEXT = v_lapsed.kood::TEXT
              AND to_char((lk.properties ->> 'alg_kpv')::DATE, 'DD.MM.YYYY') = left(v_lapsed.alg_kpv, 10)
              AND to_char((lk.properties ->> 'lopp_kpv')::DATE, 'DD.MM.YYYY') = left(v_lapsed.lopp_kpv, 10)
              AND lk.properties ->> 'yksus' = v_lapsed.yksus
              AND staatus < 3;


            IF v_kaart.id IS NOT NULL
            THEN
                -- ищем сл. дату
                SELECT (lk.properties ->> 'alg_kpv')::DATE
                INTO l_kpv
                FROM lapsed.lapse_kaart lk
                WHERE parentid = v_kaart.parentid
                  AND nomid = v_kaart.nomid
                  AND v_kaart.properties ->> 'yksus' <> lk.properties ->> 'yksus'
                  AND (lk.properties ->> 'alg_kpv')::DATE > (v_kaart.properties ->> 'alg_kpv')::DATE
                ORDER BY (lk.properties ->> 'alg_kpv')::DATE
                LIMIT 1;

                RAISE NOTICE 'found % l_kpv %', v_kaart.id, l_kpv;

                -- меняем дату

                IF l_kpv IS NOT NULL
                THEN
                    UPDATE lapsed.lapse_kaart
                    SET properties = properties::JSONB || jsonb_build_object('lopp_kpv', l_kpv - 1)
                    WHERE id = v_kaart.id;
                END IF;

                l_count = l_count + 1;
            END IF;
        END LOOP;

    RETURN l_count;

END ;
$$;

SELECT tmp_update_teenused();

DROP FUNCTION IF EXISTS tmp_update_teenused();

/*
 select trim(replace(vn,E'\n',''),'"'), vn, ik, asutus from tmp_viitenr_kustuta

SELECT id FROM ou.rekv WHERE left(nimetus, 10) = left(trim('"0911027 Narva Lasteaed Pongerjas T"','"'), 10) LIMIT 1

          FROM lapsed.viitenr
            WHERE isikukood = v_vn.ik
              AND rekv_id = l_rekv_id
              AND viitenumber = trim(replace(v_vn.vn,E'\n',''),'"');

select * from tmp_viitenr_kustuta
 where vn = '9366554'

 */
