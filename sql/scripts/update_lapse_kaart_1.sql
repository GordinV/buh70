
DROP TABLE IF EXISTS tmp_lapsed;
CREATE TABLE IF NOT EXISTS tmp_lapsed (
    ik           TEXT,
    yksus        TEXT,
    kood         TEXT,
    old_alg_kpv  TEXT,
    old_lopp_kpv TEXT,
    new_alg_kpv  TEXT,
    new_lopp_kpv TEXT
);

INSERT INTO tmp_lapsed (ik, yksus, kood, old_alg_kpv, old_lopp_kpv, new_alg_kpv, new_lopp_kpv)
SELECT t.f[1]::TEXT AS ik
        ,
       t.f[2]::TEXT AS yksus
        ,
       t.f[3]::TEXT AS kood
        ,
       t.f[4]::TEXT AS old_alg_kpv
        ,
       t.f[5]::TEXT AS old_lopp_kpv
        ,
       t.f[6]::TEXT AS new_alg_kpv
        ,
       t.f[7]::TEXT AS new_lopp_kpv

FROM (
         SELECT regexp_split_to_array(l, ';') AS f
         FROM regexp_split_to_table(
                      $$51711200027;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;30.04.2021
51711200027;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;30.04.2021
51712200043;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51712200043;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51712200043;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51712200043;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51712200043;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51802260127;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51802260127;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51802260127;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51802260127;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51802260127;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51803160224;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51803160224;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51803160224;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51803160224;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51803160224;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51807060097;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51807060097;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51807060097;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51807060097;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51807060097;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51809090051;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51809090051;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51809090051;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51809090051;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51809090051;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51812210173;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51812210173;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51812210173;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51812210173;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51812210173;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51812210173;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51812210173;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51812210173;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51812210173;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51812210173;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51901110096;LAED-001-09;322020-014;1.12.2021;1.05.2022;1.12.2021;31.05.2022
51901110096;LAED-001-09;322030-016;1.12.2021;1.05.2022;1.12.2021;31.05.2022
51901110096;LAED-001-09;322040-003;1.12.2021;1.05.2022;1.12.2021;31.05.2022
51901110096;LAED-001-09;322040-004;1.12.2021;1.05.2022;1.12.2021;31.05.2022
51901110096;LAED-001-09;322040-005;1.12.2021;1.05.2022;1.12.2021;31.05.2022
51902130114;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51902130114;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51902130114;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51902130114;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51902130114;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903040153;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.08.2021
51903040153;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.08.2021
51903040153;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.08.2021
51903040153;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.08.2021
51903040153;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.08.2021
51903040153;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903040153;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903040153;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903040153;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903040153;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903250248;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51903250248;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51903250248;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51903250248;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2021
51903250248;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51903250248;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903250248;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903250248;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903250248;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51903250248;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
51907010217;LAED-001-05;322020-014;4.01.2021;31.12.2010;31.12.2020;15.04.2021
51907010217;LAED-001-05;322030-016;4.01.2021;31.12.2010;31.12.2020;15.04.2021
51907010217;LAED-001-05;322040-003;4.01.2021;31.12.2010;31.12.2020;15.04.2021
51907010217;LAED-001-05;322040-004;4.01.2021;31.12.2010;31.12.2020;15.04.2021
51907010217;LAED-001-05;322040-005;4.01.2021;31.12.2010;31.12.2020;15.04.2021
51907250061;LAED-001-05;322020-014;2.08.2021;1.05.2022;2.08.2021;31.08.2021
51907250061;LAED-001-05;322030-016;2.08.2021;1.05.2022;2.08.2021;31.08.2021
51907250061;LAED-001-05;322040-003;2.08.2021;1.05.2022;2.08.2021;31.08.2021
51907250061;LAED-001-05;322040-004;2.08.2021;1.05.2022;2.08.2021;31.08.2021
51907250061;LAED-001-05;322040-005;2.08.2021;1.05.2022;2.08.2021;31.08.2021
51907250061;LAED-001-09;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
51907250061;LAED-001-09;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
51907250061;LAED-001-09;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
51907250061;LAED-001-09;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
51907250061;LAED-001-09;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
51908020207;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51908020207;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51908020207;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51908020207;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51908020207;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
51910300110;LAED-001-05;322020-014;14.09.2021;1.05.2022;14.09.2021;31.07.2022
51910300110;LAED-001-05;322030-016;14.09.2021;1.05.2022;14.09.2021;31.07.2022
51910300110;LAED-001-05;322040-003;14.09.2021;1.05.2022;14.09.2021;31.07.2022
51910300110;LAED-001-05;322040-004;14.09.2021;1.05.2022;14.09.2021;31.07.2022
51910300110;LAED-001-05;322040-005;14.09.2021;1.05.2022;14.09.2021;31.07.2022
52001300032;LAED-001-05;322020-014;2.08.2021;1.05.2022;2.08.2021;31.10.2021
52001300032;LAED-001-05;322030-016;2.08.2021;1.05.2022;2.08.2021;31.10.2021
52001300032;LAED-001-05;322040-003;2.08.2021;1.05.2022;2.08.2021;31.10.2021
52001300032;LAED-001-05;322040-004;2.08.2021;1.05.2022;2.08.2021;31.10.2021
52001300032;LAED-001-05;322040-005;2.08.2021;1.05.2022;2.08.2021;31.10.2021
52004040046;LAED-001-06;322020-014;2.08.2021;1.05.2022;2.08.2021;31.07.2022
52004040046;LAED-001-06;322030-016;2.08.2021;1.05.2022;2.08.2021;31.07.2022
52004040046;LAED-001-06;322040-003;3.08.2021;1.05.2022;3.08.2021;31.07.2022
52004040046;LAED-001-06;322040-004;3.08.2021;1.05.2022;3.08.2021;31.07.2022
52004040046;LAED-001-06;322040-005;3.08.2021;1.05.2022;3.08.2021;31.07.2022
52005070126;LAED-001-06;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005070126;LAED-001-06;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005070126;LAED-001-06;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005070126;LAED-001-06;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005070126;LAED-001-06;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005270127;LAED-001-05;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005270127;LAED-001-05;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005270127;LAED-001-05;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005270127;LAED-001-05;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
52005270127;LAED-001-05;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61801070053;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801070053;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801070053;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801070053;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801070053;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801160096;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801160096;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801160096;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801160096;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61801160096;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61803010174;LAED-001-04;322020-014;31.12.2020;1.05.2022;31.12.2020;31.01.2021
61803010174;LAED-001-04;322030-016;31.12.2020;1.05.2022;31.12.2020;31.01.2021
61803010174;LAED-001-04;322040-003;31.12.2020;1.05.2022;31.12.2020;31.01.2021
61803010174;LAED-001-04;322040-004;31.12.2020;1.05.2022;31.12.2020;31.01.2021
61803010174;LAED-001-04;322040-005;31.12.2020;1.05.2022;31.12.2020;31.01.2021
61803220214;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61803220214;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61803220214;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61803220214;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61803220214;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61805080190;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61805080190;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61805080190;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61805080190;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61805080190;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806020217;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806020217;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806020217;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806020217;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806020217;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806130252;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806130252;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806130252;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806130252;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61806130252;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61807120206;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61807120206;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61807120206;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61807120206;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61807120206;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61809190167;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61809190167;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61809190167;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61809190167;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61809190167;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61810300163;LAED-001-04;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61810300163;LAED-001-04;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61810300163;LAED-001-04;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61810300163;LAED-001-04;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61810300163;LAED-001-04;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61811120115;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;30.04.2021
61811120115;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;30.04.2021
61811120115;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;30.04.2021
61811120115;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;30.04.2021
61811120115;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;30.04.2021
61812030101;LAED-001-05;322020-014;31.12.2020;31.12.2010;31.12.2020;31.08.2021
61812030101;LAED-001-05;322030-016;31.12.2020;31.12.2010;31.12.2020;31.08.2021
61812030101;LAED-001-05;322040-003;31.12.2020;31.12.2010;31.12.2020;31.08.2021
61812030101;LAED-001-05;322040-004;31.12.2020;31.12.2010;31.12.2020;31.08.2021
61812030101;LAED-001-05;322040-005;31.12.2020;31.12.2010;31.12.2020;31.08.2021
61812030101;LAED-001-09;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61812030101;LAED-001-09;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61812030101;LAED-001-09;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61812030101;LAED-001-09;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61812030101;LAED-001-09;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901250098;LAED-001-05;322020-014;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61901250098;LAED-001-05;322030-016;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61901250098;LAED-001-05;322040-003;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61901250098;LAED-001-05;322040-004;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61901250098;LAED-001-05;322040-005;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61901250098;LAED-001-09;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901250098;LAED-001-09;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901250098;LAED-001-09;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901250098;LAED-001-09;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901250098;LAED-001-09;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61901260083;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61901260083;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61901260083;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61901260083;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61901260083;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61901260083;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61901260083;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61901260083;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61901260083;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61901260083;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61902050047;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;30.04.2022
61902050047;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;30.04.2022
61902050047;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;30.04.2022
61902050047;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;30.04.2022
61902050047;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;30.04.2022
61902050047;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61902050047;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61902050047;LAED-001-06;322040-003;1.01.2021;31.12.2010;1.01.2021;31.07.2021
61902050047;LAED-001-06;322040-004;1.01.2021;31.12.2010;1.01.2021;31.07.2021
61902050047;LAED-001-06;322040-005;1.01.2021;31.12.2010;1.01.2021;31.07.2021
61902060152;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61902060152;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61902060152;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61902060152;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61902060152;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61902060152;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61902060152;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61902060152;LAED-001-06;322040-003;15.04.2021;31.12.2010;15.04.2021;31.07.2021
61902060152;LAED-001-06;322040-004;15.04.2021;31.12.2010;15.04.2021;31.07.2021
61902060152;LAED-001-06;322040-005;15.04.2021;31.12.2010;15.04.2021;31.07.2021
61905150144;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2022
61905150144;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2022
61905150144;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2022
61905150144;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2022
61905150144;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2022
61906030017;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61906030017;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61906030017;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61906030017;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61906030017;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61906030017;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61906030017;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61906030017;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61906030017;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61906030017;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61907070133;LAED-001-04;322020-014;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61907070133;LAED-001-04;322030-016;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61907070133;LAED-001-04;322040-003;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61907070133;LAED-001-04;322040-004;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61907070133;LAED-001-04;322040-005;1.08.2021;1.05.2022;1.08.2021;31.07.2022
61907070133;LAED-001-06;322020-014;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61907070133;LAED-001-06;322030-016;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61907070133;LAED-001-06;322040-003;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61907070133;LAED-001-06;322040-004;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61907070133;LAED-001-06;322040-005;31.12.2020;31.12.2010;31.12.2020;31.07.2021
61908060157;LAED-001-05;322020-014;27.08.2021;1.05.2022;27.08.2021;31.08.2021
61908060157;LAED-001-05;322030-016;27.08.2021;1.05.2022;27.08.2021;31.08.2021
61908060157;LAED-001-05;322040-003;27.08.2021;1.05.2022;27.08.2021;31.08.2021
61908060157;LAED-001-05;322040-004;27.08.2021;1.05.2022;27.08.2021;31.08.2021
61908060157;LAED-001-05;322040-005;27.08.2021;1.05.2022;27.08.2021;31.08.2021
61908060157;LAED-001-09;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908060157;LAED-001-09;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908060157;LAED-001-09;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908060157;LAED-001-09;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908060157;LAED-001-09;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908140054;LAED-001-05;322020-014;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61908140054;LAED-001-05;322030-016;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61908140054;LAED-001-05;322040-003;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61908140054;LAED-001-05;322040-004;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61908140054;LAED-001-05;322040-005;23.08.2021;1.05.2022;23.08.2021;31.08.2021
61908140054;LAED-001-09;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908140054;LAED-001-09;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908140054;LAED-001-09;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908140054;LAED-001-09;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61908140054;LAED-001-09;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
61912130129;LAED-001-05;322020-014;21.04.2021;31.12.2010;21.04.2021;31.07.2022
61912130129;LAED-001-05;322030-016;21.04.2021;31.12.2010;21.04.2021;31.07.2022
61912130129;LAED-001-05;322040-003;21.04.2021;31.12.2010;21.04.2021;31.07.2022
61912130129;LAED-001-05;322040-004;21.04.2021;31.12.2010;21.04.2021;31.07.2022
61912130129;LAED-001-05;322040-005;21.04.2021;31.12.2010;21.04.2021;31.07.2022
62003230014;LAED-001-06;322020-014;2.08.2021;1.05.2022;2.08.2021;31.07.2022
62003230014;LAED-001-06;322030-016;2.08.2021;1.05.2022;2.08.2021;31.07.2022
62003230014;LAED-001-06;322040-003;2.08.2021;1.05.2022;2.08.2021;31.07.2022
62003230014;LAED-001-06;322040-004;2.08.2021;1.05.2022;2.08.2021;31.07.2022
62003230014;LAED-001-06;322040-005;2.08.2021;1.05.2022;2.08.2021;31.07.2022
62005120109;LAED-001-06;322020-014;1.09.2021;1.05.2022;1.09.2021;31.07.2022
62005120109;LAED-001-06;322030-016;1.09.2021;1.05.2022;1.09.2021;31.07.2022
62005120109;LAED-001-06;322040-003;1.09.2021;1.05.2022;1.09.2021;31.07.2022
62005120109;LAED-001-06;322040-004;1.09.2021;1.05.2022;1.09.2021;31.07.2022
62005120109;LAED-001-06;322040-005;1.09.2021;1.05.2022;1.09.2021;31.07.2022
62007290043;LAED-001-06;322020-014;11.10.2021;1.05.2022;11.10.2021;31.07.2022
62007290043;LAED-001-06;322030-016;11.10.2021;1.05.2022;11.10.2021;31.07.2022
62007290043;LAED-001-06;322040-003;11.10.2021;1.05.2022;11.10.2021;31.07.2022
62007290043;LAED-001-06;322040-004;11.10.2021;1.05.2022;11.10.2021;31.07.2022
62007290043;LAED-001-06;322040-005;11.10.2021;1.05.2022;11.10.2021;31.07.2022$$, '\n') AS l) t;

DROP FUNCTION IF EXISTS tmp_update_lapse_kaart_1();

CREATE FUNCTION tmp_update_lapse_kaart_1()
    RETURNS INTEGER
    LANGUAGE plpgsql
AS
$$
DECLARE
    v_lapsed RECORD;
    l_count  INTEGER = 0;
    v_kaart  RECORD;
    l_kpv    DATE;
BEGIN
    FOR v_lapsed IN
        SELECT to_date(old_alg_kpv, 'DD.MM.YYYY')  AS old_alg_kpv,
               to_date(old_lopp_kpv, 'DD.MM.YYYY') AS old_lopp_kpv,
               ik,
               yksus,
               kood,
               to_date(new_alg_kpv, 'DD.MM.YYYY')  AS new_alg_kpv,
               to_date(new_lopp_kpv, 'DD.MM.YYYY') AS new_lopp_kpv

        FROM tmp_lapsed
        WHERE ik IS NOT NULL
--          AND ik IN ('62003230014')

        LOOP
            RAISE NOTICE '% % % % % %',v_lapsed.ik, v_lapsed.yksus, v_lapsed.old_alg_kpv, v_lapsed.old_lopp_kpv, v_lapsed.new_alg_kpv, v_lapsed.new_lopp_kpv;

            -- ищем запись
            SELECT lk.id,
                   (lk.properties ->> 'alg_kpv')::DATE  AS alg_kpv,
                   (lk.properties ->> 'lopp_kpv')::DATE AS lopp_kpv,
                   lk.properties ->> 'yksus'            AS yksus,
                   n.kood
            INTO v_kaart
            FROM lapsed.lapse_kaart lk
                     INNER JOIN libs.nomenklatuur n ON n.id = lk.nomid
            WHERE lk.rekvid = 92
              AND lk.staatus < 3
              AND lk.parentid IN (SELECT id FROM lapsed.laps WHERE isikukood = v_lapsed.ik AND laps.staatus < 3)
              AND (lk.properties ->> 'yksus' IS NOT NULL AND lk.properties ->> 'yksus' = v_lapsed.yksus)
              AND (lk.properties ->> 'alg_kpv')::DATE = v_lapsed.old_alg_kpv::DATE
              AND (lk.properties ->> 'lopp_kpv')::DATE = v_lapsed.old_lopp_kpv::DATE
              AND n.kood = v_lapsed.kood;
            RAISE NOTICE 'found % ', v_kaart;

            RAISE NOTICE 'if % % % % % %', v_kaart.alg_kpv, v_lapsed.new_alg_kpv, v_kaart.lopp_kpv, v_lapsed.new_lopp_kpv, (v_kaart.alg_kpv <> v_lapsed.new_alg_kpv), v_kaart.lopp_kpv <> v_lapsed.new_lopp_kpv;


            IF (v_kaart.id IS NOT NULL AND (v_kaart.alg_kpv <> v_lapsed.new_alg_kpv OR
                                            v_kaart.lopp_kpv <> v_lapsed.new_lopp_kpv))
            THEN
                -- update

                RAISE NOTICE 'update ...';
                UPDATE lapsed.lapse_kaart
                SET properties= properties::JSONB ||
                                jsonb_build_object('alg_kpv', v_lapsed.new_alg_kpv, 'lopp_kpv', v_lapsed.new_lopp_kpv)
                WHERE id = v_kaart.id;
            END IF;

        END LOOP;

    RETURN l_count;

END ;
$$;

SELECT tmp_update_lapse_kaart_1();

DROP FUNCTION IF EXISTS tmp_update_lapse_kaart_1();

/*
 select trim(replace(vn,E'\n',''),'"'), vn, ik, asutus from tmp_viitenr_kustuta

SELECT id FROM ou.rekv WHERE left(nimetus, 10) = left(trim('"0911027 Narva Lasteaed Pongerjas T"','"'), 10) LIMIT 1

          FROM lapsed.viitenr
            WHERE isikukood = v_vn.ik
              AND rekv_id = l_rekv_id
              AND viitenumber = trim(replace(v_vn.vn,E'\n',''),'"');

select * from tmp_viitenr_kustuta
 where vn = '9366554'

 */
